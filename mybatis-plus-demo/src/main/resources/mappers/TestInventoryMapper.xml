<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.gy.demo.mybatisplus.mapper.TestInventoryMapper">


    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.gy.demo.mybatisplus.entity.TestInventory">
        <id column="id" property="id" />
        <result column="qty" property="qty" />
        <result column="version" property="version" />
        <result column="product_id" property="productId" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, qty, version, product_id
    </sql>

    <!-- 单个插入或更新（插入和更新都只处理非空字段） -->
    <insert id="upsertSelective">
        INSERT INTO test_inventory
        <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    id,
                </if>
                <if test="qty != null">
                    qty,
                </if>
                <if test="version != null">
                    version,
                </if>
                <if test="productId != null">
                    product_id,
                </if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
                <if test="id != null">
                    #{id},
                </if>
                <if test="qty != null">
                    #{qty},
                </if>
                <if test="version != null">
                    #{version},
                </if>
                <if test="productId != null">
                    #{productId},
                </if>
        </trim>
        AS new
        ON DUPLICATE KEY UPDATE
        <trim suffixOverrides=",">
                <if test="qty != null">
                    qty = new.qty,
                </if>
                <if test="version != null">
                    version = new.version,
                </if>
                <if test="productId != null">
                    product_id = new.product_id,
                </if>
        </trim>
    </insert>

    <!-- 批量插入或更新（插入和更新都只处理非空字段） -->
    <insert id="batchUpsertSelective">
        INSERT INTO test_inventory
        <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="list[0].id != null">
                    id,
                </if>
                <if test="list[0].qty != null">
                    qty,
                </if>
                <if test="list[0].version != null">
                    version,
                </if>
                <if test="list[0].productId != null">
                    product_id,
                </if>
        </trim>
        VALUES
        <foreach collection="list" item="item" separator=",">
            <trim prefix="(" suffix=")" suffixOverrides=",">
                    <if test="item.id != null">
                        #{item.id},
                    </if>
                    <if test="item.qty != null">
                        #{item.qty},
                    </if>
                    <if test="item.version != null">
                        #{item.version},
                    </if>
                    <if test="item.productId != null">
                        #{item.productId},
                    </if>
            </trim>
        </foreach>
        AS new
        ON DUPLICATE KEY UPDATE
        <trim suffixOverrides=",">
                <if test="list[0].qty != null">
                    qty = new.qty,
                </if>
                <if test="list[0].version != null">
                    version = new.version,
                </if>
                <if test="list[0].productId != null">
                    product_id = new.product_id,
                </if>
        </trim>
    </insert>

    <!-- 批量更新库存（插入和更新都只处理非空字段） -->
    <insert id="batchUpdateQty">
        INSERT INTO test_inventory
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="list[0].id != null">
                id,
            </if>
            <if test="list[0].qty != null">
                qty,
            </if>
            <if test="list[0].version != null">
                version,
            </if>
            <if test="list[0].productId != null">
                product_id,
            </if>
        </trim>
        VALUES
        <foreach collection="list" item="item" separator=",">
            <trim prefix="(" suffix=")" suffixOverrides=",">
                <if test="item.id != null">
                    #{item.id},
                </if>
                <if test="item.qty != null">
                    #{item.qty},
                </if>
                <if test="item.version != null">
                    #{item.version},
                </if>
                <if test="item.productId != null">
                    #{item.productId},
                </if>
            </trim>
        </foreach>
        AS new
        ON DUPLICATE KEY UPDATE
        <trim suffixOverrides=",">
            <if test="list[0].qty != null">
                qty = new.qty + test_inventory.qty,
            </if>
            version = test_inventory.version + 1
        </trim>
    </insert>
</mapper>